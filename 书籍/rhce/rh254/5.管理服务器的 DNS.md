# 5. 管理服务器的 DNS

## DNS概念

* 域名系统
* DNS 查询分析

### 域名系统

域名系统(DNS)是一个层次命名系统, 充当联网主机和资源的目录. 目录中的信息将网络名称映射到数据, 并且在称为资源记录的逻辑条目中维护.

DNS的层次结构顶部和分支以`root`域**"."**开始, 向下直至多个下一级别域.

#### 域 domain

域是资源记录的集合. 这些资源记录以公用名称结尾并且表示DNS名称空间的整个子树. 最大的域是`root`域**"."**, 包括整个DNS名称空间.

#### 顶级域(TLD)

* 主题: `.com`, `.edu`, `.net`
* 国家: `.us`, `.uk`, `.ru`

#### 子域 subdomain

子域是指作为另一个域的子树的域. `lab.example.com`是`example.com`的子域.

#### 区域 zone

区域是指特定名称服务器直接负责或对其具有权威的某个域组成部分. 可以是整个域, 或者只是域的一部分(其部分或所有子域被委派给其他名称服务器)

### DNS 查询分析

名称解析时将首先向`/etc/resolv.conf`中列出的服务器依次发送查询, 直到它获得相应或查询了全部列出的服务器.

#### 本地权威数据

查询到`DNS`服务器时, 服务器首先确定正在查询的信息是否驻留在服务器对其有权威的区域中. 如果服务器是所查询名称或地区所属区域的权威, 那么服务器将以其本地区域文件中包含的信息响应客户端. 这种类型的响应称为**权威答案(aa)**.

#### 本地的缓存非权威数据

如果`DNS`服务器不是相关记录的权威, 因为最近查询过, 在其缓存中具有一份记录副本. 缓存时间是根据`TTL`来确定的. 如果服务器的缓存中存在答案, 此答案不会设置`aa`标志, 因为服务器对提供的数据没有权威.

#### 通过递归获取的远程非权威数据

如果`DNS`服务器对于正在查询的名称没有权威, 则`DNS`服务器不会在其缓存中占有记录. `DNS`服务器随后将尝试通过称为递归的迭代过程来检索记录.

首先查询根名称服务器, 从而开始递归过程.

最终答案以及在最终答案之前获取的所有中间答案都将由`DNS`服务器进行缓存以提高性能. 如果在查询`www.example.com`期间, `DNS`服务器发现`example.com`去油具有权威名称服务器, 则它将针对任何将来查询, 直接查询这些服务器以获取`exmaple.com`区域中的信息, 而不是在根名称服务器中重新启动递归.

### DNS 资源记录

* `owner-name`: 该资源记录的名称
* `TTL`: 资源记录的生存时间(秒). 这会指定`DNS`解析器应缓存此资源记录的时间长度.
* `class`: 记录的"类", 几乎总是`IN`(表示`Internet).
* `type`: 类型. `A`表示主机名映射到`IPv4`地址.
* `data`: 此记录存储的数据.

资源记录类型:

* `A`: `IPv4`地址
* `AAAA`: `IPv6`地址
* `CNAME`: 资源记录将一个记录别名化为另一个记录(规范名称), 其中应具有`A`或`AAAA`记录. 当`DNS`解析器收到`CNAME`记录作为查询的响应时, `DNS`解析器将使用规范名称(而非原始名称)重新发出查询.
	* `CNAME`应指向`A`或`AAAA`记录
	* `CND`可以指向`CNAME`
	* `NS`和`MX`记录不得指向`CNAME`记录, 而是指向名称包含`A`或`AAAA`记录的名称.
* `PTR`(指针)记录, `PTR`记录将`IPv4`或`IPv6`地址映射到主机名. 它们用于反向`DNS`解析. 对于`IPv4`地址, 地址被**逆向**, 最具体的部分在最前面, 并且结果被视为特属域`in-addr.arpa`的子域中的主机.
* `NS`(名称服务器)记录: `NS`记录将域名映射到`DNS`名称服务器, 而后者对其`DNS`域具有权威.
* `SOA`(授权起始)记录: 记录提供了有关`DNS`区域工作方式的信息. 每个区域正好有一个`SOA`记录, 其指定区域的哪个名称服务器是**主**, 哪个是**次**. 以及**次**如何更新其信息副本的信息以及区域的管理联系方式.
	* `Master namewerver`: 名称服务器主机名.
	* `RNAME`: `DNS`区域负责人的电子邮件地址.
	* `Serial number`: 区域版本号.
	* `Refresh`: 从服务器应检查区域更新的频率.
	* `Expiry`: 如果刷新失败, 从服务器在停止使用其旧的区域副本响应查询之前应等待时间.
	* `Minimum`: 解析器应将"记录不存在"这一信息进行缓存的持续时间.
* `MX`: 邮件交换记录. 记录映射到邮件交换, 后者将接受该名称的电子邮件.
* `TXT`: 文版记录.
* `SRV`: 服务记录, 用于查找支持域的特定服务的主机. 格式设置为包含服务和写名称的域名`_service._protocol.domainname`.

### 主机和资源记录

## 配置缓存名称服务

* 缓存名称服务器和 DNSSEC
* 将 unbound 作为缓存名称服务器进行配置和管理

### 缓存名称服务器和 DNSSEC

缓存名称服务器将在本地缓存中存储`DNS`查询结果. 并且在`TTL`到期后从缓存中删除资源记录. 通常设置缓存名称服务器以代表本地网络上的客户端执行查询.

**DNSSEC**验证, 鉴于`UDP`的无状态性质, `DNS`事务很容易被欺骗和篡改. 利用`DNS`服务器软件中的漏洞来欺骗`DNS`服务器接收恶意数据并将其填充到其缓存中.**DNSSEC**验证可在将资源记录置于缓存中供客户端使用之前验证资源记录的真实性和完整性, 从而防止客户端遭受缓存中毒.

### 将 unbound 作为缓存名称服务器进行配置和管理

## DNS 故障排除

* DNS 故障排除
* DNS 响应代码
* 其他常见 DNS 问题

### DNS 故障排除

**dig**是一个用于调查`DNS`问题的工具.

首先使用主机文件`/etc/hosts`, 按照`/etc/nsswitch.conf`中指定的顺序来尝试名称解析. 

### DNS 响应代码

`dig`的输出的`HEADER`部分中的`status`字段报告`DNS`服务器为响应客户端的查询而生成的响应代码.

DNS 返回代码:

* SERVFAIL: 名称服务器在处理查询时遇到问题.
* NXDOMAIN: 查询名称在区域中不存在.
* REFUSED: 由于策略限制, 名称服务器拒绝了客户端的DNS请求.

### 其他常见 DNS 问题

* 过期的缓存数据
* 对不存在的记录的响应, 查询记录时仍收到响应, 可能是设定了通配符. `*.example.com IN A xxx.xxx.xx.xx`
* 非`FQDN`名称错误, 在区域文件中, 要指示某个名称在区域文件中是`FQDN`, 名称必须以`.`结尾.
* 对`CNAME`记录进行循环, 避免`CNAME`指向`CNAME`.
* 确认`PTR`记录.
* 循环`DNS`. 一个名称可以就有多个A或AAAA记录, 客户端通常使用集中的第一个地址.

