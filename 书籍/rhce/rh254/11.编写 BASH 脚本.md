# 11. 编写 BASH 脚本

## Bash shell 脚本编写基础知识

* Bash 脚本编写基础知识
* 创建和执行 Bash shell 脚本
* 显示输出
* 使用变量
* 使用 Bash shell 扩展功能
* shell 脚本错误故障排除

### Bash 脚本编写基础知识

`Bash shell`脚本是一个由命令列表构成的可执行文件.

#### 命令解释器

`Bash shell`脚本的第一行以`#!`开头. 这种两字节表示法在技术上称为**幻数模式**. 其表示文件是可执行的`shell`脚本. 后面的路径名称是命令解释器, 也就是应该用于执行脚本的程序.

```shell
#!/bin/bash
```

修改其文件权限和所有权, 以使其变为可执行文件. 可使用`chmod`命令修改执行权限.

某个`Bash shell`脚本变为可执行, 可通过子啊命令行中输入其名称来调用. 如果只输入了脚本文件的基本名称, `Bash`将搜索在`shell`的`PATH`环境变量中指定的目录, 以查找与该名称匹配的可执行文件文件的第一个实例.

### 显示输出

`echo`命令用于显示任意文本, 可以定向到标准输出, 标准错误或者重定向到日志文件以进行存档.

#### 对特殊字符加银行

转义字符`\`可取消紧跟在该字符后面的单个字符的特殊含义.

使用单引号"'"可以转义文本字符串中的多个字符.

```shell
echo '# not a comment #'
```

单引号保留其阔气的所有字符的字面值, 双引号的区别在于双引号不保留美元符号`$`, 反引号"\`\`"和反斜杠`\`的字面值.

```shell
echo "$HOME"
/home/student

echo "`pwd`"
/home/student
```

### 使用变量

#### 为变量分配值

```shell
VARIABLENAME=value
```

变量中存储的常见数据类型是整数值和字符串值. 为变量分配字符串值时, 一种良好作坊是用引号将其括起. 否则`Bash`会将空格字符解释为单词分隔符.

#### 扩展变量值

`$VARIABLENAME`是花括号引起的变量扩展形式`${VARIABLENAME}`的简化版本.

### 使用 Bash shell 扩展功能

#### 命令替换

命令替换可将命令的调用替换为执行命令后的输出. 该功能允许在新上下文中使用命令的输出, 如另一个命令的参数, 变量的值以及循环结构的列表.

`<COMMAND>` 或 `$(<COMMAND>)`

如:

```shell
`date`

$(date)
```

示例:

```shell
TAROUTPUT=$(tar cvf /tmp/incremental_backup.tar $(find /etc -type f -mtime -l))
```

`find`命令的输出用作`tar`命令的参数, 而`tar`命令随后将其输出存储到变量`TAROUTOUT`中.

#### 算术扩展

用于执行简单的整数算术运算.

`$[<EXPRESSION>]`. 用`$[]`括起时, 算术表达式将由 Bash 进行求职, 然后替换为求值结果.

```shell
echo $[1+1]
2

echo $[2*2]
4
```

算术扩展中使用的表达式允许使用空格字符. 使用空格字符可以改善可读性.

* `<VARIABLE>++` 变量后置递增 **第1优先级**
* `<VARIABLE>--` 变量后置递减 **第1优先级**
* `++<VARIABLE>` 变量前置递增 **第2优先级**
* `--<VARIABLE>` 变量前置递减 **第2优先级**
* `-` 一元减法 **第3优先级**
* `+` 一元加法 ( a = +a ) **第3优先级**
* `**` 求幂 **第4优先级**
* `*` 乘法 **第5优先级**
* `/` 除法 **第5优先级**
* `%` 求余 **第5优先级**
* `+` 加法 **第6优先级**
* `-` 减法 **第6优先级**

### 迭代 for 循环

```shell
for <VARIABLE> in <LIST>; do
	<COMMAND>
	...
	<COMMAND> referencing <VARIABLE>
done
```

### shell 脚本错误故障排除

**调试模式**

```shell
#!/bin/bash -x
```

或者

```shell
bash -x <SCRIPTNAME>
```

可以仅仅对脚本的某一部分而非整个脚本, 局部启用**调试模式**.

插入命令:

* `set -x`: 开启
* `set +x`：关闭

分别在脚本中的特定位置**开启或关闭调试**.

**详细模式**

```shell
#!/bin/bash -v
```

插入命令:

* `set -v`: 开启
* `set +v`: 关闭