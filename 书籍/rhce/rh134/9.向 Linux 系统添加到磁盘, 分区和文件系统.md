# 9.向 Linux 系统添加到磁盘, 分区和文件系统

## 添加分区, 文件系统和永久挂载

* 磁盘分区
* 使用 fdisk 管理 MBR 分区
* 使用 gdisk 管理 GPT 分区
* 创建文件系统
* 挂载文件系统

### 磁盘分区

磁盘分区可以将硬盘驱动器划分为**多个逻辑存储单元**, 这些单元称为分区.

优点:

* 限制应用或用户的可用空间
* 允许从同一磁盘进行不同操作系统的多重启动
* 将操作系统和程序文件与用户文件分隔开
* 创建用于操作系统虚拟内存交换的单独区域
* 限制磁盘空间使用情况

#### MBR 分区方案

支持最多四个主分区. `Linux`系统上, 可以使用扩展分区和逻辑分区来创建最多**15**个分区.

由于分区大小数据以32位存储, 使用`MBR`方案分区时, **最大磁盘和分区带下限制为 2 TiB**.

#### GPT 分区方案

`GPT`是在物理硬盘上布置分区的标准.

* 128个分区.
* 逻辑块地址为 64 位, 最左支持 8 ZiB (521字节的块大小). 如果是 4,096字节块, 限制增加至 `64 ZiB`.
* `MBR`单一故障点, `GPT`提供分区表信息的冗余. 主`GPT`位于磁盘头部, 备份副本(次要 GPT)位于磁盘尾部.
* 采用`CRC`校验和来检测`GPT`头和分区表中的错误与损坏.

### 使用 fdisk 管理 MBR 分区

`fdisk`命令, 指定磁盘设备名称作为参数.

最后运行`partprobe`命令, 将磁盘设备名称作为参数, 以强制重新读取其分区表.

### 使用 gdisk 管理 GPT 分区

使用`gdisk`管理磁盘分区.

### 创建文件系统

文件系统将向块设备应用一种结构, 这样就可以**存储数据并从其中检索数据**.

`mkfs` 用于为块设备应用文件系统.

* `-t`指定文件系统类型.

```
mkfs -t xfs /dev/vdb1
```

### 挂载文件系统

将文件系统连接到目录结构中. 文件系统连接到目录层次结构中后, 用户控件程序可以访问设备上的文件文件或在设备上写入文件.

永久挂载需要添加到`/etc/fstab`文件中. 每行具有六个字段:

1. 要使用的设备
	* UUID
	* 设备文件(/dev/vdb1)
2. 设备应连接到目录层次结构中的挂载点
3. 应用于块设备的文件系统类型
4. 挂载时应用于设备的选项列表
5. 转储标志
	* 和`dump`命令配合使用, 用于生成设备内容的备份
6. fsck顺序
	* 确定在文件系统未完全卸载的情况下, 是否应在启动时运行`fsck`. 顺序值表示当有多个文件系统需要检查时, 应对这些文件系统运行`fsck`的顺序
	
`mount -a`将读取`/etc/fstab`, 将该文件系统重新挂载到原位, 以验证条目是否有效.

## 管理交换空间

* 交换空间概念
* 创建交换空间
* 激活交换空间

### 交换空间概念

交换空间是可与`Linux`内核内存管理子系统配合使用的磁盘区域. 交换空间用于通过保存不活动的内存页面来补充系统`RAM`. 系统`RAM`与交换空间组合在一起成为虚拟内存.

当系统上的内存使用量超过定义的限制时, 内存将梳理`RAM`, 寻找已分配给进程但空闲的内存页. 内核将空闲的内存页写入到交换区, 并且重新分配`RAM`页面以供其他进程使用. 如果某个程序需要访问已写入到磁盘的页面, 则内核会找到另一个空闲的内存页, 将其写入到磁盘, 然后从交换区重新调用所需的页面.

**交换非常慢**

### 创建交换空间

* 创建分区
* 将该分区的类型设置为`82 Linux Swap`
* 对设备进行交换签名格式化
	* `mkswap`在**设备开头写入单个数据块, 而将设备的其余部分保留为未格式化, 从而使其可用于存储内存页**.

### 激活交换空间

`swapon`将激活已格式化的交换空间. `swapon -a`将激活`/etc/fstab`文件中累出的所有交换空间.

`swapoff`停用交换空间. 只有当任何交换的数据都可以写入到其他活动的交换空间或写回到内存中时, `swapoff`才会成功. 否则会失败.

`/etc/fstab`

* 第二个字段: `swap`(占位符), 因为交换设备无法通过目录结构访问.

默认情况下按顺序使用. `swapon -s`显示交换空间优先级. 可使用`pri=xx`挂在项设置这些优先级. 如果交换空间具有相同优先级, 则**内核将循环写入到这些空间, 而并非写入单个交换空间直至其容量已满**.