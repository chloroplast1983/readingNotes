# 8.控制服务和守护进程

## 识别自动启动的系统进程

* systemd 简介
* 使用 systemctl 列出单元文件

### systemd 简介

系统启动和服务进程由 `systemd` 系统和服务管理器进行管理. 在启动时和运行中的系统上激活系统资源, 服务器守护进程和其他进程.

**守护进程**是在执行各种任务的后台等待或运行的进程. 许多守护进程的名称以字母"d"结束.

为了侦听连接, 守护进程使用套接字. 这是与本地或远程客户端的主要通信通道. 套接字可能由守护进程创建, 或者可能从守护进程隔开并通过另一进程创建, 如`systemd`.

服务通常指的是一个或多个守护进程, 但启动或停止一项服务可能会对系统的状态进行一次性更改, 不会留下守护进程之后继续运行(`oneshot`).

#### init 进程和 systemd 进程

旧的系统进程`ID`为`1`的进程属于`init`进程.

在红帽7中, 进程`ID`为`1`的属于`systemd`这一新的`init`系统.

优点:

* 并行化功能, 提高系统的启动速度
* 按需启动守护进程, 不需单独的服务
* 自动服务依赖关系管理, 防止长时间超时
* 利用`Linux`控制组一起追踪相关进程的方式

#### systemctl 和 systemd 单元

`systemctl`命令用于管理各种类型的`systemd`对象, 称为单元.

常用单元类型

* `.service`, 代表系统服务. 用于守护进程.
* `.socket`, 代表进程间通信(`IPC`)套接字.
* `.path`, 用于将服务的激活推迟到特定文件系统更改发生之后, 常用于打印系统.

服务状态:

* `loaded`, 单元配置文件已处理.
* `active(running)`, 正在通过一个或多个持续进程运行.
* `active(exited)`, 已成功完成一次性配置.
* `active(waiting)`, 运行中, 正在等待事件.
* `inactive`, 不在运行.
* `enabled`, 将在系统启动时启动.
* `disabled`, 不会在系统启动时启动.
* `static`, 无法启用, 但可有某一启用的单元自动启动.

### 使用 systemctl 列出单元文件

```
systemctl list-units --type=service
```

## 控制系统服务

* 启动和停止运行中系统上的系统守护进程
* 使系统守护进程在系统启动时启动或停止
* systemctl 命令摘要

### 启动和停止运行中系统上的系统守护进

**单元依赖项**

服务可能会以其他服务依赖项的形式启动. 如果套接字单元已启用, 但名称相同的服务单元没有启动, 对该网络套接字发出请求时将自动启动该服务.

`systemctl list-dependencies UNIT`命令用于打印出启动指定单元时必须要启动的其他单元的树型列表.

**屏蔽服务**

`systemctl mask xxx`

#### 禁用和屏蔽

**禁用**的服务不会在系统启动时自动启动, 也不会被其他单元文件启动, 但可以手动启动.

**屏蔽**的服务无法手动启动, 也不会自动启动.

#### 使系统守护进程在系统启动时启动或停止

`systemd` 配置目录中创建有链接时, 服务会在系统启动时启动. 这些链接也可以通过`systemctl`命令创建和删除.

```
systemctl enable xxx
systemctl disable xxx
```

### systemctl 命令摘要

`systemctl COMMAND unit`

* `status`: 查看状态信息
* `stop`: 停止
* `start`: 启动
* `restart`: 重新启动
* `reload`: 重新加载配置文件
* `mask`: 屏蔽
* `unmask`: 接触屏蔽
* `enable`: 开机启动
* `disable`: 禁止开机启动
* `list-dependencies`: 列出指定单元需要的单元

