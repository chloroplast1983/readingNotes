# 12.归档文件并在系统间复制文件

## 管理压缩的 tar 存档

* 什么是 tar
* 操作 tar 命令
* 使用 tar 归档文件和目录
* 列出 tar 存档的内容
* 提取用 tar 创建的存档
* 创建压缩的 tar 存档
* 提取压缩的 tar 存档

### 什么是 tar

通过`tar`命令, 可以将大型文件集汇集为一个文件(存档). 该存档可以使用`gzip, bzip2`或`xz`压缩方式压缩.

`tar`命令:

* 列出文档内容
* 将其文件提取到当前系统

### 操作 tar 命令

* `c`: 创建文档
* `t`: 列出存档的内容
* `x`: 提取存档
* `f filename`: 要操作的存档的文件名
* `v`: 详细信息

**选项前不需要使用`-`**

### 使用 tar 归档文件和目录

`tar`命令将覆盖现有的存档.

忽略用户没有读权限的文件, 将忽略用户没有读和执行权限的名录.

```
#创建名为 archive.tar 存档, 其内容为用户主目录的 file1, file2, 和 file3
tar cf archive.tar file1 file2 file3
```

### 列出 tar 存档的内容

```
列出存档 /root/etc.tar 的内容
tar tf /root/etc.tar
```

### 提取用 tar 创建的存档

`tar`存档通常应当提取的**空目录**中, 以确保它**不会覆盖任何现有的文件**.

* `root`用户提取文件, `tar`将尝试保留文件的原始用户和组所有权.
* 普通用户使用`tar`提取文件, 则提取的文件由该用户所有.

默认情况, 提取文档时, **从存档内容的权限中去除`umask`**

`p`选项可以保留存档文件的权限.

### 创建压缩的 tar 存档

* `z`, gzip. 压缩速度最快, 应用最广.
* `j`, bzip2. 比`gzip`生成的文件小.
* `J`, xz, 最佳的压缩率.

```
tar zcf xxx.tar.gz xxx
```

### 提取压缩的 tar 存档

通常不需要使用在创建存档时所用的同一压缩选项, 因为`tar`命令会判断之前使用的压缩方式.

```
tar zxf xxx.tar.gz
```

## 在系统间安全地复制文件

* 使用 scp 命令将文件复制到远程位置, 或从中复制文件
* 使用 sftp 远程传输文件

### 使用 scp 命令将文件复制到远程位置, 或从中复制文件

`scp`命令可将文件从远程主机传输到本地系统, 反之亦然. 它**利用 SSH 服务器进行身份验证和加密数据传输**.

远程文件系统位置始终以`[user@]host:/path`格式指定. 无论是来源还是目标位置. `user@`是可选的, 如果缺少则使用调用`scp`命令的当前本地用户.

启动传输之前, 用户必须通过密码或`SSH`密钥与`SSH`服务器进行身份验证.

可以用递归`-r`的方式复制整个目录.

```
# serverX 上的远程目录 /var/log 以递归方式复制到 本地目录 /tmp/

scp -r root@serverX:/var/log /tmp
```

### 使用 sftp 远程传输文件

`sftp`的会话与典型的`FTP`会话相似, 但使用`sSH`服务器的安全身份验证机制和加密数据传输功能.

`sftp`需要一个`[user@]host`格式的远程位置. `user@`可选, 如果没有指明则使用调用`sftp`命令的用户.

**命令使用参考ftp**

## 在系统间安全地同步文件

* 使用 rsync 命令同步文件和文件夹

### 使用 rsync 命令同步文件和文件夹

`rsync` 工具是在系统之间安全复制文件的方式. 和`scp`区别在于, 如果两个系统间的两个文件或目录相似, `rsync`仅需要**复制系统间的差异部分**, 而`scp`则需要复制所有内容.

参数:

* `-n`: 空运行, 模拟执行的更改.
* `-v`: 输出详细信息.
* `-a`: 存档模式, 一次性启动协下列所有选项.
	* `-r`: 递归方式同步整个目录.
	* `-l`: 同步符号链接.
	* `-p`: 保留权限.
	* `-t`: 保留时间戳.
	* `-g`: 保留组所有权.
	* `-o`: 保留文件所有者.
	* `-D`: 同步设备文件
* `-H`: 硬链接处理. 识别来源文件中的硬链接, 在目标文件夹中相应地链接文件, 而不是仅将它们作为单独的文件进行复制.
* `-A`: ACL 同步
* `-X`: SELinux 同步

如果仅同步文件夹的内容而不创建文件夹, 源目录的末尾需要加上一个尾部斜杠.

```
# /tmp 目录创建 log 目录及其内容
rsync -av /var/log /tmp

# /tmp 目录仅同步 /var/log/ 目录的内容(不同步目录)
rsync -av /var/log/ tmp
```

若要让`rsync`同步所传输文件的所有权, 必须以`root`用户身份写入到目标位置.

**一般 rsync 配合 inotify 命令使用**
