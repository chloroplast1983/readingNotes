# 10.管理逻辑卷管理(LVM)存储

## 逻辑卷管理概念

* 逻辑卷管理(LVM)概念

### 逻辑卷管理(LVM)概念

* 物理设备是用于保留逻辑卷中所存储数据的存储设备. 是块设备. 设备必须初始化为**LVM物理卷**, 才能与LVM结合使用. **整个"设备"将用作一个物理卷**.
* 物理卷(PV)用于注册基础物理设备以便在卷组中使用. LVM 自动将 PV 划分为**物理区块(PE)**: 他们是充当 PV 上最小存储快的小块数据.
* 卷组(VG)是**存储池, 由一个或多个物理卷组成**. **一个 PV 只能分配给一个 VG. VG 可以包含未使用的空间和任意数目的逻辑卷**.
* 逻辑卷(LV)根据卷组中的空闲物理范围创建. **LV 是逻辑区块(LE)的集合, LE 映射到物理区块PE(PV 的最小存储块)**. 默认, 每个 LE 将因社会到一个 PE. 设置特定 LV 选项将会更改此映射. 如, **镜像**会导致每个 LE 映射到两个 PE.

![](./img/10_01.jpg)

## 管理逻辑卷

* 实施 LVM 存储
* 删除逻辑卷
* 查看 LVM 状态信息

### 实施 LVM 存储

#### 1. 准备物理设备

使用`fdisk, gdisk, parted`创建新分区, 以便于`LVM`结合使用. 分区类型设置为`0x8e`.

#### 2. 创建物理卷

使用`pvcreate`为分区(或其他物理设备)**添加标签**. 使其作为物理卷. **会将用于存储 LVM 配置数据的一个标头直接写入到 PV**. PV 分为多个固定大小物理范围(PE).

#### 3. 创建卷组

`vgcreate`用于创建包含一个或多个物理卷的池, 称为卷组. VG 负责通过向 LV 分配空闲 PE 来托管一个或多个逻辑卷. 

一般可在需要时扩展现有 VG 以容纳新的 LV.

#### 4. 创建逻辑卷

`lvcreate` 根据卷组中的可用物理范围创建新的逻辑卷.

* `-n`: LV 名称.
* `-L`: LV 大小(以字节为单位).
* `-l`: 以`le`为单位制定大小.

不同工具将使用:

* 传统名称: `/dev/vgname/lvname`
* 内核设备映射程序名: `/dev/mapper/vgname-lvname`

显示逻辑卷名.

#### 5. 添加文件系统

使用`mkfs`在新逻辑卷上创建文件系统.

### 删除逻辑卷

* 卸载文件系统`umount`
* 删除逻辑卷`lvremove`
* 删除卷组`vgremove`
* 删除物理卷`pvremove`

### 查看 LVM 状态信息

`pvdisplay`显示物理卷信息.

* `PV Name`: 映射到设备名称.
* `VG Name`: 显示将 PV 分配到的卷组.
* `PV Size`: 显示 PV 的物理大小, 包括任何不可用的空间.
* `PE Size`: 物理范围大小, 是逻辑卷中可分配的最小大小. `LVM`可以指定该大小.
* `Free PE`: 显示有多少 PE 单位可用于分配个新逻辑卷.

`vgdisplay`显示卷组的信息.

* `VG Name`: 卷组名称.
* `VG Size`: 是存储池可用于逻辑卷分配的总带下.
* `Total PE`: 以 PE 单位表示的总大小.
* `Free PE / Size`: 显示 VG 中有多少空闲空间可用于分配给新 LV 或扩展现有 LV.

`lvdisplay`显示逻辑卷信息.

* `LV Path`: 逻辑卷的设备名称.
* `VG Name`: 显示从其分配 LV 的卷组.
* `LV Size`: LV 的总大小.
* `Current LE`: 显示此 LV 使用的逻辑范围数. LE 通常映射到 VG 中的物理范围, 并因此映射到物理卷.

## 扩展逻辑卷

* 扩展和缩减卷组
* 扩展逻辑卷和 XFS 文件系统
* 扩展逻辑卷和 ext4 文件系统

### 扩展和缩减卷组

可以通过添加额外的物理卷来为卷组增加更多磁盘空间. 称为**扩展卷组**. 由额外的物理卷提供的新物理区段可以分配各逻辑卷.

将未使用的物理卷从卷组中删除. 称为**缩减卷组**.

`pvmove`将数据从一个物理卷上的区段移动到卷组中其他物理卷上的区段. 用于转移磁盘.

#### 扩展卷组

* 准备物理设备, 分区
* 创建物理卷
* 扩展卷组`vgextend`
* 验证, `vgdisplay`

#### 缩减卷组

* 移动物理区段`pvmove`, 将物理上使用的任何物理区段重新分配个 VG 中的其他 PV. 仅当 VG 中存在足够的空闲范围, 且所有这些范围都来自其他 PV 时.

```
pvmove /dev/vdb2
```

移动到同一 VG 中具有空闲 PE 的 PV.

* 缩减卷组, `vgreduce`将物理卷从卷组中删除.

### 扩展逻辑卷和 XFS 文件系统

* 验证卷组是否有可用的空间, `vgdisplay`
* 扩展逻辑卷, `lvextend`
* 扩展文件系统, `xfs_grwofs`(传参 挂载点), 要求在文件系统运行时挂载该系统.

### 扩展逻辑卷和 ext4 文件系统

* 验证卷组是否有可用的空间, `vgdisplay`
* 扩展逻辑卷, `lvextend`
* 扩展文件系统, `resize2fs`(传参 逻辑卷名称)