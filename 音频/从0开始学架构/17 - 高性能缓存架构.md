# 17 | 高性能缓存架构

## 笔记

### 缓存

基本原理就是**将可能重复使用的数据放到内存中, 一次生成, 多次使用, 避免每次使用都去访问存储系统**.

### 缓存穿透

是指缓存没有发挥作用, 业务系统虽然去缓存查询数据, 单缓存中没有数据, 业务系统需要再次去存储系统查询数据.

#### 存储数据不存在

用户访问, 存储系统中没有某个数据, 则不会再缓存中存储响应的数据. 每次用户查询:

* 缓存找不到
* 存储也找不到

**缓存在这个场景中没有起到分担存储系统访问压力的作用**

**解决**, 如果查询存储系统的数据没有找到, 则直接设置一个默认值存到缓存中, 这样第2次读取缓存时就会获取到默认值, 而不会继续访问存储系统.

#### 缓存数据生成耗费大量时间或者资源

缓存生成时间过长, 或者需要耗费大量资源. 如果刚好在业务访问的时候缓存失效了, 那么也会出现缓存没有发挥作用, 访问压力全部集中在存储系统上的情况.

### 缓存雪崩

是指缓存失效(过期)后引起系统性能急剧下降的情况. 当缓存过期被清除后, 业务系统需要重新生成缓存. 同时多个请求去生成缓存, 并且处理这些请求的线程都不知道另外有一个线程正在生成缓存，因此所有的请求都会去重新生成缓存, 都会去访问存储系统, 从而对存储系统造成巨大的性能压力. 这些压力又会拖慢整个系统, 严重的会造成数据库宕机, 从而形成一系列连锁反应, 造成整个系统崩溃,

**解决**

* 更新锁机制
	* 对更新操作进行加锁保护, 保证只有一个线程能够进行缓存更新, 未能获取更新锁的线程要么等待锁释放后重新读取缓存, 要么就返回空值或者默认值.
	* 分布式系统要实现更新锁机制, 需要用到分布式锁, 如`ZooKeeper`
* 后台更新机制
	* 后台定时更新缓存
	* 适合系统预热, 不是等待用户访问才来触发缓存加载

### 缓存热点

复制多份缓存副本, 将请求分散到多个缓存服务器上, 减轻缓存热点导致的单台缓存服务器压力.

```
对于粉丝超过100万的明星, 每条微博可以生成100份缓存, 缓存的数据是一样的, 通过在缓存的key里面加上编号进行分区, 每次读缓存时都随机读取某份缓存.
```

设定一个过期时间范文, 不同的缓存副本的过期时间是指定范围内的随机值. 防止出现缓存雪崩.

## 扩展