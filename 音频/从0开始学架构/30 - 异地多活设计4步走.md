# 30 | 异地多活设计4步走

## 笔记

### 1. 业务分级

业务分级, 只为核心业务设计异地多活, 降低方案整体复杂度和实现成本.

分级标准:

* 访问量大的业务
* 核心业务
* 产生大量收入的业务

### 2. 数据分类

数据特征分析:

* 数据量: 数据量越大, 同步延迟的几率越高.
* 唯一性: 是否要求多个异地机房产生的同类数据必须保证唯一.
	* 数据不需要唯一, 两个地方可以产生同类数据.
	* 数据需要唯一
		* 只能一个中心点产生数据
		* 设计一个数据唯一生成的算法
* 实时性: A机房修改了数据, 要求多久必须同步到B机房.
	* 实时性要求越高, 对同步要求越高, 方案约复杂
* 可丢失性: 数据是否可以丢失.
	* `session`数据可以丢失
	* `ID`数据不可丢失
* 可恢复性: 数据丢失后, 是否可以通过某种手段进行恢复. 
	* 用户密码丢了, 可以找回密码. 是可恢复的.
	* 用户账户丢失, 用户无法登录, 假设系统也无法恢复, 则是不可恢复的.

**可以按照这几个数据分类维度对业务数据进行分析**

### 3. 数据同步

* 存储系统同步
* 消息队列同步: 适合**无事务性**和**无时序性**
	* 用户A, 用户B注册了账户. 同步无时序性要求.
	* 用户A先改了密码为m, 在改为n. 则 m 和 n 就需要有时序性.
* 重复生成
	* cookie
	* session
	* 缓存

### 4. 异常处理

目的:

* 问题发生时, **避免少量数据异常**导致整体业务不可用.
* 问题恢复后, 将**异常的数据进行修正**.
* 弥补用户损失.

#### 异常处理措施 - 1.多通道同步

多种方式进行数据同步. 如果某条通道故障, 系统可以通过其他方式来进行同步.

![](./img/30_01.png)

关键点:

* 一般两通道即可
* 两个通道不能采用相同的网络, 否则一旦网络故障, 两个通道同时故障.
* 数据可以重复覆盖. 
	* 新建账户可以符合这个标准
	* 密码数据不符合这个标准

#### 异常处理措施 - 2.同步和访问结合

异地机房通过系统的接口来进行数据访问.

如图: B 机房的业务系统通过接口来访问A机房的系统获取账户信息.

![](./img/30_02.png)

关键点:

* 接口访问和数据同步通道不能采用相同的网络连接.
* 数据有路由规则, 根据路由规则判断去哪个机房访问数据.(不同机房存储不同数据)
* 优先读取本地数据, 本地数据无法读取到在通过接口去访问. **适用于实时性要求非常高的数据**

#### 异常处理措施 - 3.日志记录

用于用户故障恢复后对数据进行恢复. 每个关键操作前后都记录一条日志, 然后将日志保存在一个独立的地方. 当故障恢复后，可以使用日志对数据进行修复.

日志保存方式:

* 服务器上保存日志, 数据库中保存数据.
* 本地独立系统保存日志.
* 日志异地保存

#### 异常处理措施 - 4.用户补偿

**系统方案是为了保证 99.99% 的用户在故障的场景下业务不受影响, 人工的补偿是为了弥补 0.01% 的用户损失**.

## 扩展