# 协议专栏特别福利 | 答疑解惑第一期

## 《第 1 讲 | 为什么要学习网络协议？》

### 1. 当网络包到达一个城关的时候，可以通过路由表得到下一个城关的 IP 地址，直接通过 IP 地址找就可以了，为什么还要通过本地的 MAC 地址呢?

在网络包里有源`IP`地址和目标`IP`地址, 源`MAC`地址和目标`MAC`地址.

从路由表中取得下一跳的 IP 地址后，应该把这个地址放在哪里呢？如果放在目标 IP 地址里面，到了城关，谁知道最终的目标在哪里呢？所以要用 MAC 地址。

**所谓的下一跳**，看起来是 IP 地址，其实是要通过 ARP 得到 MAC 地址，将下一跳的 MAC 地址放在目标 MAC 地址里面。

### 2. TCP 重试有没有可能导致重复下单？

**不会的**, 因为 TCP 层收到了重复包之后，TCP 层自己会进行去重，发给应用层、HTTP 层。还是一个唯一的下单请求，所以不会重复下单。

**重复下单**, 因为网络原因或者服务端错误，导致 TCP 连接断了，这样会重新发送应用层的请求，也即 HTTP 的请求会重新发送一遍。

### 3. TCP 报平安的包是原路返回吗?

原路返回的意思是原样返回，也就是返回也是这个过程，不一定是完全一样的路径。

### 4. IP 地址和 MAC 地址的关系？

IP 是有远程定位功能的，MAC 是没有远程定位功能的，只能通过本地 ARP 的方式找到。

### 5. 如果最后一跳的时候，IP 改变了怎么办？

**拔掉网线** 对于 IP 层来讲，当包到达最后一跳的时候，原来的 IP 不存在了。比如网线拔掉了，或者服务器直接宕机了，则 ARP 就找不到了，所以这个包就会发送失败了。对于 IP 层的工作就结束了。

**TCP重试** 但是 IP 层之上还有 TCP 层，TCP 会重试的，包还是会重新发送，但是如果服务器没有启动起来，超过一定的次数，最终放弃。

**服务重启, IP正确, 端口不正确** 如果服务器重启了，IP 还是原来的 IP 地址，这个时候 TCP 重新发送的一个包的时候，ARP 是能够得到这个地址的，因而会发到这台机器上来，但是机器上面没有启动服务端监听那个端口，于是会发送 ICMP 端口不可达。

**都正确, 但是`Sequence Number`对不上** 如果服务器重启了，服务端也重新启动了，也在监听那个端口了，这个时候 TCP 的服务端由于是新的，Sequence Number 根本对不上，说明不是原来的连接，会发送 RST。

**虚拟机热迁移** 但是有一个非常特殊的方式，就是虚拟机的热迁移，从一台物理机迁移到另外一台物理机，IP 不变，MAC 不变，内存也拷贝过去，Sequence Number 在内存里面也保持住了，在迁移的过程中会丢失一两个包，但是从 TCP 来看，最终还是能够连接成功的。

### 6. ARP 协议属于哪一层？

**有争议的**。《TCP/IP 详解》把它放在了二层和三层之间。

## 扩展

### 1.一个域名如果对应多个IP，那么实际访问这个域名会访问到哪个IP哪台服务器呢

虽然DNS解析得到了多个IP，但是大多数软件只会使用第一个IP地址.

TCP/IP网络通信是基于IP地址的，当要访问的服务器地址是域名时，就需要先把域名解析成IP地址。在TCP/IP API中有一个叫gethostbyname的函数，负责把域名解析成IP地址。 函数的原型定义如下，参数name就是要解析的域名。

```
struct hostent *gethostbyname(const char *name);
```

函数的返回值为一个结构体指针，这个结构体的定义为：

```
struct hostent {
    char  *h_name;            /* official name of host */
    char **h_aliases;         /* alias list */
    int    h_addrtype;        /* host address type */
    int    h_length;          /* length of address */
    char **h_addr_list;       /* list of addresses */
}
#define h_addr h_addr_list[0] /* for backward compatibility */
```

结构体中的h_addr_list是一个数组，用于存放解析出的多个IP地址，但很少有程序员会去考虑多个IP地址的问题，通常直接使用宏h_addr来获取IP地址，也就是第一个IP地址。一些大型网站或CDN服务商为了实现负载均衡，他们的DNS服务器会动态改变多个IP地址的顺序，使得每个IP地址都有机会成为解析结果中的第一个IP地址。