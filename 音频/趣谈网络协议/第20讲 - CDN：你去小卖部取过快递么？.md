# 第20讲 | CDN：你去小卖部取过快递么？

## 笔记

### 边缘节点, 区域节点, 中心节点

![](./img/20_01.jpg)

* 边缘节点
	* 外层
	* 多
	* 缓存内容少
	* 缓存命中率低
* 区域节点
	* 规模大
	* 缓存数据多
	* 缓存命中率高
* 中心节点
	* 规模更大
	* 缓存树多多
* 如果还不命中, 回源网站访问

### 客户端如何找到相应的边缘节点进行访问呢

类似`DNS`的负载均衡

![](./img/20_02.jpg)

#### 没有CDN

正常从`DNS`递归查询到网站`www.web.com`的`IP`地址, 访问.

#### 有CDN

会在`web.com`这个**权威`DNS`服务器上, 设置一个`CNAME`别名**, 指向另外一个域名`www.web.cdn.com`, 返回给本地`DNS`服务器.

本地`DNS`服务器拿到这个新域名时, 需要**继续解析**这个新的域名. 这个时候在访问的就不是`web.com`的权威`DNS`服务器了, 而是`web.cnd.com`的权威`DNS`服务器, 这是`CDN`自己的权威`DNS`服务器. 在这个服务器上, 还是会设置一个`CNAME`, 指向另外一个域名, 也即`CDN`网络的全局负载均衡器.

**本地`DNS`服务器去请求`CDN`的全局负载均衡器解析域名**, 全局负载均衡器会为用户选择一台合适的缓存服务器提供服务(返回一台缓存服务器的`IP`地址).

* 根据用户`IP`地址, 判断哪一台服务器距用户最近
* 用户所处的运营商
* 根据用户所请求的`URL`中携带的内容名称, 判断哪一台服务器上有用户所需的内容
* 查询各个服务器当前的负载情况, 判断哪一台服务器尚有服务能力

客户端去访问这个边缘节点, 下载资源. 缓存服务器响应用户请求, 将用户所需内容传送给用户. 如果这台服务器没有用户想要的内容, 那么这台服务器就要向它的上一级缓存服务器请求内容, 直至追溯到王赞的源服务器将内容拉到本地.

### CDN 缓存的内容种类

静态页面, 图片等.

![](./img/20_03.jpg)

`CDN`更进一步, 将这些静态资源缓存到离用户更近的数据中心外. **越接近客户, 访问性能约好, 时延越低**.

静态页面, 内容往往采取**拉取**的方式, 即当发现未命中, 再去上一级进行拉取.

#### CDN 流媒体

`CDN`支持流媒体协议.

流媒体数据量大, 如果出现**回源**, 压力会比较大, 往往采取主动推送的模式, 将热点数据主动推送到边缘节点.

提供**预处理服务**, 文件在分发之前, 经过一定的处理. (将视频转换为不同的码流, 以适应不同的网络带宽的用户需求...)

##### 防盗链

**HTTP头的 `refer` 字段**. 检查`refer`如果不是来自本站, 就组织访问或者跳到其它链接.

**时间戳防盗** 

* 和`CDN`厂商约定一个加密字符串. 
* 客户端取出当前的时间戳.
* 要访问的资源及其路径.

进行签名算法, 得到加密后的字符串和截止时间戳去访问`CDN`.

### 动态 CDN

#### 生鲜超市模式

边缘计算模式. 数据的路基计算和存储, 放在边缘节点. 定时从源数据那里同步存储的数据, 在边缘进行计算得到结果.

#### 冷链运输模式

路径优化模式. 数据是在源站生成的. 数据下发通过`CDN`, 对路径进行优化. 找到离用户很近的边缘节点.

### CDN 加速TCP传输

`TCP`链接在公网传输经常会丢失数据, 导致`TCP`的窗口始终很小. 在`CDN`加速网络中可以调整`TCP`的参数(流量控制和拥塞控制). 使得`TCP`可以更加**激进地**传输数据.

通过多个请求复用一个连接, 减少握手和过多的建立链接. 

对数据传输进行压缩.

## 扩展