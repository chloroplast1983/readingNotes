# 协议专栏特别福利 | 答疑解惑第三期

## 笔记

### 1. ping 使用的是什么网络编程接口

对于`ping`来讲, 使用的是`ICMP`, 创建`Socket`如下:

```
socket(AF_INET, SOCK_RAW, IPPROTO_ICMP)
```

**SOCK_RAW 就是基于 IP 层协议建立通信机制**.

对比`TCP`和`UDP`

* `socket(AF_INET, SOCK_STREAM, IPPROTO_TCP)` **TCP**
* `socket(AF_INET, SOCK_DGRAM, IPPROTO_UDP)` **UDP**

### 2. ICMP 差错报文是谁发送的呢

ICMP 包是由**内核返回的**，在内核中，有一个函数用于发送 ICMP 的包。

```
void icmp_send(struct sk_buff *skb_in, int type, int code, __be32 info);
```

目标不可达:

```
icmp_send(skb, ICMP_DEST_UNREACH, ICMP_PROT_UNREACH, 0);
```

当`IP`大小超过`MTU`的时候, 发送需要分片的`ICMP`.

```
if (ip_exceeds_mtu(skb, mtu)) {
  icmp_send(skb, ICMP_DEST_UNREACH, ICMP_FRAG_NEEDED, htonl(mtu));
  goto drop;
 }
```

### 3. NAT出去以及返回的时候, 怎么智能的NAT成了你的IP而非别人的IP呢?

### 4. NAT 能建立多少连接?

`conntrack` 是由**{源 IP，源端口，目标 IP，目标端口}，hash 后确定的**.

* 内网访问不同的外网, 也即目标IP和目标短偶很多. 这样就不止`65535`个(端口号)
* 如果目标IP, 目标端口为同一个. 这样源`Ip`只有一个, 在这样的情况下, 才受`65535`的端口数限制.
	* 多个源IP, 分摊不同的内网机器访问.
	* 多个NAT网关, 分摊不同的内网机器访问.

## 扩展